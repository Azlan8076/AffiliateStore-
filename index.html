<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>♥️ Affiliate Store ♥️</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .scrolling-text {
            white-space: nowrap;
            overflow: hidden;
            position: relative;
        }
        .scrolling-text span {
            display: inline-block;
            padding-left: 100%;
            animation: marquee 15s linear infinite;
        }
        @keyframes marquee {
            0% { transform: translate(0, 0); }
            100% { transform: translate(-100%, 0); }
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            position: relative;
        }
        .image-gallery {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }
        .image-gallery img {
            width: 100%;
            height: auto;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="message-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4 text-center">
            <h3 class="text-xl font-bold mb-4">Notification</h3>
            <p id="modal-message" class="text-gray-700"></p>
            <button onclick="hideModal()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none">OK</button>
        </div>
    </div>
    
    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-content text-center">
            <h3 class="text-xl font-bold mb-4">Confirmation</h3>
            <p id="confirm-modal-message" class="text-gray-700 mb-6"></p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-yes-button" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600">Yes</button>
                <button id="confirm-no-button" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">No</button>
            </div>
        </div>
    </div>
    
    <div id="admin-profile-modal" class="modal-overlay">
        <div id="admin-profile-content" class="modal-content">
        </div>
    </div>
    
    <div id="product-detail-modal" class="modal-overlay">
        <div id="product-detail-content" class="modal-content">
        </div>
    </div>
    
    <div id="buy-product-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-2xl font-bold">Buy Product</h3>
                <button onclick="hideBuyProductModal()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div id="buy-product-content">
                <p id="buy-product-message" class="mb-4 text-gray-700"></p>
                <input type="number" id="buy-product-amount" placeholder="Enter Amount" class="w-full px-4 py-3 mb-4 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button onclick="submitProductRequest()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-md hover:bg-blue-700 transition duration-300">Submit Request</button>
            </div>
        </div>
    </div>

    <div id="admin-chat-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-2xl font-bold">Chat with <span id="admin-chat-user-name"></span></h3>
                <button onclick="hideAdminChatModal()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div id="admin-chat-messages" class="flex flex-col h-96 overflow-y-auto mb-4 p-2 border border-gray-200 rounded-md space-y-4"></div>
            <div class="flex">
                <input type="text" id="admin-chat-input" placeholder="Write a reply..." class="flex-grow px-4 py-2 rounded-l-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button onclick="sendAdminReply()" class="bg-blue-600 text-white px-4 py-2 rounded-r-md hover:bg-blue-700"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <div id="auth-page" class="flex flex-col items-center justify-center min-h-screen">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
            <h2 class="text-3xl font-bold mb-6 text-center text-blue-600">EarnHub</h2>
            <div id="login-form">
                <h3 class="text-2xl font-bold mb-4 text-center">Login</h3>
                <input type="text" id="login-username" placeholder="Username" class="w-full px-4 py-3 mb-4 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="password" id="login-password" placeholder="Password" class="w-full px-4 py-3 mb-6 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button onclick="handleLogin()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-md hover:bg-blue-700 transition duration-300">Login</button>
                <p class="mt-4 text-center">
                    <a href="#" onclick="showSignupForm()" class="text-blue-600 hover:underline">Don't have an account? Sign Up</a>
                </p>
            </div>
            <div id="signup-form" class="hidden">
                <h3 class="text-2xl font-bold mb-4 text-center">Sign Up</h3>
                <input type="text" id="signup-name" placeholder="Name" class="w-full px-4 py-3 mb-4 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="password" id="signup-password" placeholder="Password" class="w-full px-4 py-3 mb-4 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="text" id="signup-reffer-code" placeholder="Referral Code (Optional)" class="w-full px-4 py-3 mb-6 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button onclick="handleSignup()" class="w-full bg-green-600 text-white font-bold py-3 rounded-md hover:bg-green-700 transition duration-300">Sign Up</button>
                <p class="mt-4 text-center">
                    <a href="#" onclick="showLoginForm()" class="text-blue-600 hover:underline">Already have an account? Login</a>
                </p>
            </div>
        </div>
    </div>

    <div id="admin-panel" class="hidden">
        <header class="bg-white shadow-md rounded-b-xl mb-4 py-4 px-6 flex items-center justify-between sticky top-0 z-10">
            <h1 class="text-2xl font-bold text-blue-600">Admin Panel</h1>
            <button onclick="handleLogout()" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600">Logout</button>
        </header>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 p-4">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-bold mb-4 text-blue-600">User Management</h3>
                <div class="mb-6 border-b pb-4">
                    <h4 class="text-lg font-bold mb-2">Register New User</h4>
                    <input type="text" id="admin-signup-name" placeholder="Name" class="w-full px-4 py-2 mb-2 rounded-md border">
                    <input type="password" id="admin-signup-password" placeholder="Password" class="w-full px-4 py-2 mb-2 rounded-md border">
                    <input type="text" id="admin-signup-reffer-code" placeholder="Referral Code (Optional)" class="w-full px-4 py-2 mb-2 rounded-md border">
                    <button onclick="adminReferUser()" class="w-full bg-green-600 text-white font-bold py-2 rounded-md hover:bg-green-700">Register User</button>
                </div>
                <div id="user-list"></div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-bold mb-4 text-blue-600">Withdrawal Requests</h3>
                <div id="withdrawal-requests"></div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-bold mb-4 text-blue-600">Order Requests</h3>
                <div id="order-requests"></div>
            </div>
            
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-bold mb-4 text-blue-600">Repurchase Income Distribution</h3>
                <div class="space-y-4 mb-4">
                    <input type="number" id="incomeAmount" placeholder="Enter Amount to Distribute" class="w-full px-4 py-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="distributeBtn" class="w-full bg-green-600 text-white font-bold py-2 rounded-md hover:bg-green-700 transition duration-300">Distribute Income</button>
                </div>
                <div id="uplineList" class="space-y-2">
                    </div>
                <div id="incomeStatusMessage" class="mt-4 text-center font-medium"></div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-bold mb-4 text-blue-600">Product Management</h3>
                <form id="product-form" onsubmit="handleProductSubmit(event)" class="space-y-4 mb-6">
                    <input type="hidden" id="product-id">
                    <input type="text" id="product-title" placeholder="Title" class="w-full px-4 py-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <textarea id="product-description" placeholder="Description" rows="3" class="w-full px-4 py-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" required></textarea>
                    <input type="number" id="product-mrp" placeholder="MRP" class="w-full px-4 py-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="number" id="product-price" placeholder="Discount Price" class="w-full px-4 py-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <input type="number" id="product-offer" placeholder="Income Offer (₹)" class="w-full px-4 py-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="number" id="product-rating" placeholder="Rating (1-5)" step="0.1" min="1" max="5" class="w-full px-4 py-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="url" id="product-image1" placeholder="Image URL 1 (Main)" class="w-full px-4 py-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <input type="url" id="product-image2" placeholder="Image URL 2 (Optional)" class="w-full px-4 py-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="url" id="product-image3" placeholder="Image URL 3 (Optional)" class="w-full px-4 py-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="url" id="product-video" placeholder="YouTube Video URL (Optional)" class="w-full px-4 py-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 rounded-md hover:bg-blue-700 transition duration-300">Add/Update Product</button>
                </form>
                <div id="product-list-admin"></div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-bold mb-4 text-blue-600">Video Management</h3>
                <form id="video-form" class="space-y-4 mb-6">
                    <input type="hidden" id="video-id">
                    <input type="text" id="video-name" placeholder="Video Name" class="w-full px-4 py-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="url" id="video-url" placeholder="YouTube Video URL" class="w-full px-4 py-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 rounded-md hover:bg-blue-700 transition duration-300">Add/Update Video</button>
                </form>
                <div id="video-list-admin"></div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-bold mb-4 text-blue-600">App's Games Link Management</h3>
                <form id="app-link-form" class="space-y-4 mb-6">
                    <input type="hidden" id="app-link-id">
                    <input type="text" id="app-link-name" placeholder="Link Name" class="w-full px-4 py-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="url" id="app-link-url" placeholder="Website URL" class="w-full px-4 py-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 rounded-md hover:bg-blue-700 transition duration-300">Add/Update Link</button>
                </form>
                <div id="app-links-admin"></div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg col-span-1 md:col-span-2 lg:col-span-3">
                <h3 class="text-xl font-bold mb-4 text-blue-600">Public Message & Chat Reply</h3>
                <div class="mb-4">
                    <input type="text" id="public-message" placeholder="Write a public message" class="w-full px-4 py-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button onclick="postPublicMessage()" class="mt-2 w-full bg-green-500 text-white font-bold py-2 rounded-md hover:bg-green-600">Post Message</button>
                </div>
                <div id="admin-chat-list"></div>
            </div>
        </div>
    </div>
    
    <div id="user-dashboard" class="hidden">
        <header class="bg-white shadow-md rounded-b-xl mb-4 py-4 px-6 sticky top-0 z-10">
            <div class="flex items-center justify-between">
                <button id="menu-button" onclick="toggleMenu()" class="text-blue-600 text-xl md:text-2xl"><i class="fas fa-bars"></i></button>
                <h1 class="text-2xl font-bold text-blue-600">EarnHub</h1>
                <span class="text-gray-600 font-medium text-sm">Total Members: <span id="total-members-count">0</span></span>
            </div>
            <div id="public-message-banner" class="bg-yellow-100 text-yellow-800 p-2 mt-4 rounded-md scrolling-text">
                <span id="public-message-text"></span>
            </div>
        </header>

        <aside id="sidebar-menu" class="fixed top-0 left-0 h-full w-64 bg-gray-900 text-white transform -translate-x-full transition-transform duration-300 ease-in-out z-20 shadow-lg p-6">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-2xl font-bold text-blue-400">Menu</h2>
                <button onclick="toggleMenu()" class="text-white text-xl"><i class="fas fa-times"></i></button>
            </div>
            <ul class="space-y-4">
                <li><a href="#" onclick="showDashboard()" class="flex items-center space-x-3 hover:text-blue-400 transition-colors"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a></li>
                <li><a href="#" onclick="showProfile()" class="flex items-center space-x-3 hover:text-blue-400 transition-colors"><i class="fas fa-user-circle"></i><span>Profile</span></a></li>
                <li><a href="#" onclick="showProducts()" class="flex items-center space-x-3 hover:text-blue-400 transition-colors"><i class="fas fa-shopping-bag"></i><span>Products</span></a></li>
                <li><a href="#" onclick="showAppsGames()" class="flex items-center space-x-3 hover:text-blue-400 transition-colors"><i class="fas fa-gamepad"></i><span>Apps & Games</span></a></li>
                <li><a href="#" onclick="showVideos()" class="flex items-center space-x-3 hover:text-blue-400 transition-colors"><i class="fas fa-video"></i><span>Product Videos</span></a></li>
                <li><a href="#" onclick="showDownline()" class="flex items-center space-x-3 hover:text-blue-400 transition-colors"><i class="fas fa-users"></i><span>My Team</span></a></li>
                <li><a href="#" onclick="showSupport()" class="flex items-center space-x-3 hover:text-blue-400 transition-colors"><i class="fas fa-headset"></i><span>Support</span></a></li>
                <li><a href="#" onclick="shareApp()" class="flex items-center space-x-3 hover:text-blue-400 transition-colors"><i class="fas fa-share-alt"></i><span>Share App</span></a></li>
                <li><button onclick="handleLogout()" class="w-full text-left flex items-center space-x-3 text-red-400 hover:text-red-500 transition-colors"><i class="fas fa-sign-out-alt"></i><span>Logout</span></button></li>
            </ul>
        </aside>
        <div id="menu-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-10 hidden" onclick="toggleMenu()"></div>

        <div class="p-4 md:p-8">

            <div id="dashboard-view" class="space-y-6">
                <h2 class="text-2xl font-bold text-blue-600 mb-6">My Dashboard</h2>
                <div id="pending-message" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-lg hidden">
                    <p class="font-bold">Your account is pending!</p>
                    <p>Please wait for admin approval.</p>
                </div>
                <div id="wallets-section" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-green-500">
                        <h3 class="font-medium text-gray-500">Total Income</h3>
                        <p id="total-income" class="text-3xl font-bold text-gray-900 mt-2">₹0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-blue-500">
                        <h3 class="font-medium text-gray-500">Referral Income</h3>
                        <p id="refer-income" class="text-3xl font-bold text-gray-900 mt-2">₹0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-purple-500">
                        <h3 class="font-medium text-gray-500">Self Income</h3>
                        <p id="self-income" class="text-3xl font-bold text-gray-900 mt-2">₹0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-orange-500">
                        <h3 class="font-medium text-gray-500">Team Repurchase</h3>
                        <p id="team-reparcez-income" class="text-3xl font-bold text-gray-900 mt-2">₹0</p>
                    </div>
                </div>
                <div id="referral-section" class="mt-6 bg-white p-6 rounded-xl shadow-lg flex flex-col items-center">
                    <h3 class="text-xl font-bold mb-2 text-blue-600">My Referral Code</h3>
                    <div class="flex items-center space-x-2">
                        <p id="my-referral-code" class="text-3xl font-bold text-green-600"></p>
                        <button onclick="copyReferralCode()" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-md hover:bg-gray-300">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                <div id="withdraw-section" class="mt-8 bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-bold mb-4 text-blue-600">Withdrawal Request</h3>
                    <p class="text-gray-600 mb-4">Minimum withdrawal amount is ₹50.</p>
                    <input type="number" id="withdraw-amount" placeholder="Amount" class="w-full px-4 py-3 mb-4 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button onclick="requestWithdrawal()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-md hover:bg-blue-700 transition duration-300">Submit Withdrawal Request</button>
                </div>
                
                <div id="products-on-dashboard" class="mt-8">
                    <h3 class="text-xl font-bold mb-4 text-blue-600">Our Top Products</h3>
                    <div id="product-list-dashboard" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                        </div>
                </div>

            </div>

            <div id="profile-view" class="hidden">
                <h2 class="text-2xl font-bold text-blue-600 mb-6">My Profile</h2>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <form id="user-profile-form" class="space-y-4">
                        <div>
                            <label class="block text-gray-700 font-bold mb-1">Name</label>
                            <input type="text" id="user-name-input" class="w-full px-4 py-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-bold mb-1">Mobile Number</label>
                            <input type="text" id="user-mobile-input" class="w-full px-4 py-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-bold mb-1">Password</label>
                            <input type="password" id="user-password-input" class="w-full px-4 py-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-bold mb-1">UPI ID</label>
                            <input type="text" id="user-upi-input" class="w-full px-4 py-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-bold mb-1">Address</label>
                            <input type="text" id="user-address-input" class="w-full px-4 py-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 rounded-md hover:bg-green-700 transition duration-300">Update Profile</button>
                    </form>
                </div>
            </div>

            <div id="products-view" class="hidden">
                <h2 class="text-2xl font-bold text-blue-600 mb-6">Our Products</h2>
                <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"></div>
            </div>

            <div id="downline-view" class="hidden">
                <h2 class="text-2xl font-bold text-blue-600 mb-6">My Team</h2>
                <div id="downline-list" class="bg-white p-6 rounded-xl shadow-lg"></div>
            </div>

            <div id="apps-games-view" class="hidden">
                <h2 class="text-2xl font-bold text-blue-600 mb-6">Apps & Games</h2>
                <p class="text-gray-600 mb-4">Play fun apps and games shared by the admin here.</p>
                <div id="app-game-links" class="space-y-4"></div>
            </div>

            <div id="videos-view" class="hidden">
                <h2 class="text-2xl font-bold text-blue-600 mb-6">Product Videos</h2>
                <p class="text-gray-600 mb-4">Watch videos about our products here.</p>
                <div id="video-links" class="space-y-4"></div>
            </div>

            <div id="support-view" class="hidden">
                <h2 class="text-2xl font-bold text-blue-600 mb-6">Support Chat</h2>
                <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col h-96">
                    <div id="chat-messages" class="flex-grow overflow-y-auto mb-4 p-2 border border-gray-200 rounded-md space-y-4"></div>
                    <div class="flex">
                        <input type="text" id="chat-input" placeholder="Write a message..." class="flex-grow px-4 py-2 rounded-l-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button onclick="sendMessageToAdmin()" class="bg-blue-600 text-white px-4 py-2 rounded-r-md hover:bg-blue-700"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB2VPjOpN7UGjwC5MfpeQE_5jau4hnY2xU",
            authDomain: "video-46de8.firebaseapp.com",
            databaseURL: "https://video-46de8-default-rtdb.firebaseio.com",
            projectId: "video-46de8",
            storageBucket: "video-46de8.firebasestorage.app",
            messagingSenderId: "363460455183",
            appId: "1:363460455183:web:ad5b95410d7f1a3d836c7a"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const usersRef = database.ref('users');
        const productsRef = database.ref('products');
        const ordersRef = database.ref('orders');
        const withdrawalsRef = database.ref('withdrawals');
        const messagesRef = database.ref('messages');
        const publicMessageRef = database.ref('publicMessage');
        const appLinksRef = database.ref('appLinks');
        const videoLinksRef = database.ref('videoLinks');
        
        // Global State Variables
        let currentUser = null;
        let isAdmin = false;
        let appShareUrl = window.location.href;
        let activeAdminChatUserId = null;
        let pendingBuyRequest = {};

        // UI Element References
        const authPage = document.getElementById('auth-page');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const userDashboard = document.getElementById('user-dashboard');
        const adminPanel = document.getElementById('admin-panel');
        const menuOverlay = document.getElementById('menu-overlay');
        const sidebarMenu = document.getElementById('sidebar-menu');
        const messageModal = document.getElementById('message-modal');
        const modalMessage = document.getElementById('modal-message');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalMessage = document.getElementById('confirm-modal-message');
        const confirmYesButton = document.getElementById('confirm-yes-button');
        const confirmNoButton = document.getElementById('confirm-no-button');
        const adminProfileModal = document.getElementById('admin-profile-modal');
        const adminProfileContent = document.getElementById('admin-profile-content');
        const productDetailModal = document.getElementById('product-detail-modal');
        const productDetailContent = document.getElementById('product-detail-content');
        const buyProductModal = document.getElementById('buy-product-modal');
        const buyProductMessage = document.getElementById('buy-product-message');
        const buyProductAmountInput = document.getElementById('buy-product-amount');
        const adminChatModal = document.getElementById('admin-chat-modal');
        const adminChatMessages = document.getElementById('admin-chat-messages');
        const adminChatInput = document.getElementById('admin-chat-input');
        const adminChatUserName = document.getElementById('admin-chat-user-name');
        const dashboardView = document.getElementById('dashboard-view');
        const profileView = document.getElementById('profile-view');
        const productsView = document.getElementById('products-view');
        const downlineView = document.getElementById('downline-view');
        const appsGamesView = document.getElementById('apps-games-view');
        const videosView = document.getElementById('videos-view');
        const supportView = document.getElementById('support-view');
        const incomeAmountInput = document.getElementById('incomeAmount');
        const distributeBtn = document.getElementById('distributeBtn');
        const uplineList = document.getElementById('uplineList');
        const incomeStatusMessage = document.getElementById('incomeStatusMessage');
        const totalMembersCount = document.getElementById('total-members-count');

        // Functions to show/hide UI sections
        function showPage(pageId) {
            authPage.style.display = 'none';
            userDashboard.style.display = 'none';
            adminPanel.style.display = 'none';
            if (pageId === 'auth') authPage.style.display = 'flex';
            if (pageId === 'user') userDashboard.style.display = 'block';
            if (pageId === 'admin') adminPanel.style.display = 'block';
        }

        function showView(viewId) {
            dashboardView.style.display = 'none';
            profileView.style.display = 'none';
            productsView.style.display = 'none';
            downlineView.style.display = 'none';
            appsGamesView.style.display = 'none';
            videosView.style.display = 'none';
            supportView.style.display = 'none';
            document.getElementById(viewId).style.display = 'block';
        }
        
        function showModal(message) {
            modalMessage.innerHTML = message;
            messageModal.style.display = 'flex';
            document.querySelector('#message-modal button').onclick = () => messageModal.style.display = 'none';
        }

        function hideModal() {
            messageModal.style.display = 'none';
        }
        
        function showConfirmModal(message, onConfirm) {
            confirmModalMessage.innerText = message;
            confirmModal.style.display = 'flex';
            
            confirmYesButton.onclick = () => {
                onConfirm();
                confirmModal.style.display = 'none';
            };
            
            confirmNoButton.onclick = () => {
                confirmModal.style.display = 'none';
            };
        }

        function showAdminProfileModal(content) {
            adminProfileContent.innerHTML = content;
            adminProfileModal.style.display = 'flex';
        }

        function hideAdminProfileModal() {
            adminProfileModal.style.display = 'none';
        }

        function showProductDetailModal(content) {
            productDetailContent.innerHTML = content;
            productDetailModal.style.display = 'flex';
        }
        
        function hideProductDetailModal() {
            productDetailModal.style.display = 'none';
        }

        function showBuyProductModal(product) {
            buyProductMessage.innerText = `Please enter the amount you want to pay for "${product.title}"`;
            buyProductAmountInput.value = product.price;
            pendingBuyRequest = { productId: product.id, productTitle: product.title, price: product.price };
            buyProductModal.style.display = 'flex';
        }
        
        function hideBuyProductModal() {
            buyProductModal.style.display = 'none';
            pendingBuyRequest = {};
        }
        
        function showAdminChatModal(userName) {
            adminChatUserName.innerText = userName;
            adminChatModal.style.display = 'flex';
        }
        
        function hideAdminChatModal() {
            adminChatModal.style.display = 'none';
            activeAdminChatUserId = null;
        }


        function showLoginForm() {
            loginForm.style.display = 'block';
            signupForm.style.display = 'none';
        }

        function showSignupForm() {
            loginForm.style.display = 'none';
            signupForm.style.display = 'block';
        }

        function toggleMenu() {
            const isMenuHidden = sidebarMenu.classList.contains('-translate-x-full');
            if (isMenuHidden) {
                sidebarMenu.classList.remove('-translate-x-full');
                menuOverlay.style.display = 'block';
            } else {
                sidebarMenu.classList.add('-translate-x-full');
                menuOverlay.style.display = 'none';
            }
        }
        
        // Function to update the total members count with a base of 300
        function updateTotalMembersCount() {
            const initialMembersCount = 300; // Starting with a fake count of 300
            usersRef.on('value', (snapshot) => {
                const realMembersCount = snapshot.numChildren();
                const totalCount = initialMembersCount + realMembersCount;
                totalMembersCount.innerText = totalCount;
            });
        }

        // --- Authentication Logic ---
        async function handleLogin() {
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value.trim();

            if (!username || !password) {
                showModal('Please enter a username and password.');
                return;
            }
            
            if (username === 'admin' && password === 'admin') {
                currentUser = {
                    name: 'Admin',
                    username: 'admin',
                    role: 'admin',
                    uid: 'admin_uid'
                };
                isAdmin = true;
                showPage('admin');
                loadAdminData();
                return;
            }

            const userSnapshot = await usersRef.orderByChild('username').equalTo(username).once('value');
            if (userSnapshot.exists()) {
                const user = Object.values(userSnapshot.val())[0];
                if (user.password === password) {
                    currentUser = {
                        uid: Object.keys(userSnapshot.val())[0],
                        ...user
                    };
                    isAdmin = false;
                    showPage('user');
                    updateDashboard();
                } else {
                    showModal('Invalid username or password.');
                }
            } else {
                showModal('Invalid username or password.');
            }
        }

        async function handleSignup() {
            const name = document.getElementById('signup-name').value.trim();
            const password = document.getElementById('signup-password').value.trim();
            const referCode = document.getElementById('signup-reffer-code').value.trim();

            if (!name || !password) {
                showModal('Please fill in all required fields.');
                return;
            }
            if (name === 'admin') {
                showModal('Username "admin" is not allowed.');
                return;
            }

            const userSnapshot = await usersRef.orderByChild('username').equalTo(name).once('value');
            if (userSnapshot.exists()) {
                showModal('This username already exists. Please choose another.');
                return;
            }
            
            let uplineUid = null;
            if (referCode) {
                const refererSnapshot = await usersRef.orderByChild('username').equalTo(referCode).once('value');
                if (refererSnapshot.exists()) {
                    const referer = Object.values(refererSnapshot.val())[0];
                    if (referer.status === 'active') {
                        uplineUid = Object.keys(refererSnapshot.val())[0];
                    } else {
                        showModal('Referral code is from a pending user. Please use an active user\'s code.');
                        return;
                    }
                } else {
                    showModal('Invalid referral code. Please check again.');
                    return;
                }
            }
            
            const newUser = {
                name: name,
                username: name,
                password: password,
                referralCode: name,
                upline: uplineUid || null,
                balance: 0,
                referralIncome: 0,
                selfIncome: 0,
                teamRepurchaseIncome: 0,
                status: 'pending',
                role: 'user',
                mobile: '',
                upiId: '',
                address: ''
            };

            try {
                await usersRef.push(newUser);
                showModal('Sign up successful! Your account is pending admin approval. You can login now.');
                showLoginForm();
            } catch (error) {
                showModal('Sign up failed: ' + error.message);
            }
        }

        async function adminReferUser() {
            const name = document.getElementById('admin-signup-name').value.trim();
            const password = document.getElementById('admin-signup-password').value.trim();
            const referCode = document.getElementById('admin-signup-reffer-code').value.trim();

            if (!name || !password) {
                showModal('Please fill in name and password.');
                return;
            }
            
            const userSnapshot = await usersRef.orderByChild('username').equalTo(name).once('value');
            if (userSnapshot.exists()) {
                showModal('This username already exists.');
                return;
            }
            
            let uplineUid = null;
            if (referCode) {
                const refererSnapshot = await usersRef.orderByChild('username').equalTo(referCode).once('value');
                if (refererSnapshot.exists()) {
                    const referer = Object.values(refererSnapshot.val())[0];
                    if (referer.status === 'active') {
                        uplineUid = Object.keys(refererSnapshot.val())[0];
                    } else {
                        showModal('Referral code is from a pending user. Please use an active user\'s code.');
                        return;
                    }
                } else {
                    showModal('Invalid referral code. Please check again.');
                    return;
                }
            }

            const newUser = {
                name: name,
                username: name,
                password: password,
                referralCode: name,
                upline: uplineUid || null,
                balance: 0,
                referralIncome: 0,
                selfIncome: 0,
                teamRepurchaseIncome: 0,
                status: 'pending',
                role: 'user',
                mobile: '',
                upiId: '',
                address: ''
            };

            try {
                await usersRef.push(newUser);
                showModal('User registered by Admin successfully!');
                document.getElementById('admin-signup-name').value = '';
                document.getElementById('admin-signup-password').value = '';
                document.getElementById('admin-signup-reffer-code').value = '';
            } catch (error) {
                showModal('User registration failed: ' + error.message);
            }
        }
        
        function handleLogout() {
            currentUser = null;
            isAdmin = false;
            showPage('auth');
            showLoginForm();
        }
        
        // --- User Dashboard Logic ---
        function updateDashboard() {
            if (!currentUser) return;
            showView('dashboard-view');
            const userRef = usersRef.child(currentUser.uid);
            userRef.on('value', (snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    currentUser = { ...currentUser, ...userData };
                    document.getElementById('total-income').innerText = `₹${currentUser.balance || 0}`;
                    document.getElementById('refer-income').innerText = `₹${currentUser.referralIncome || 0}`;
                    document.getElementById('self-income').innerText = `₹${currentUser.selfIncome || 0}`;
                    document.getElementById('team-reparcez-income').innerText = `₹${currentUser.teamRepurchaseIncome || 0}`;
                    document.getElementById('my-referral-code').innerText = currentUser.username;
                    
                    if (currentUser.status === 'pending') {
                        document.getElementById('pending-message').style.display = 'block';
                        document.getElementById('wallets-section').style.display = 'none';
                        document.getElementById('withdraw-section').style.display = 'none';
                        document.getElementById('referral-section').style.display = 'none';
                    } else {
                        document.getElementById('pending-message').style.display = 'none';
                        document.getElementById('wallets-section').style.display = 'grid';
                        document.getElementById('withdraw-section').style.display = 'block';
                        document.getElementById('referral-section').style.display = 'flex';
                    }
                }
            });
            loadProductsDashboard();
        }
        
        function showProfile() {
            showView('profile-view');
            if (currentUser) {
                document.getElementById('user-name-input').value = currentUser.name || '';
                document.getElementById('user-mobile-input').value = currentUser.mobile || '';
                document.getElementById('user-upi-input').value = currentUser.upiId || '';
                document.getElementById('user-address-input').value = currentUser.address || '';
                document.getElementById('user-password-input').value = '';
            }
        }
        
        document.getElementById('user-profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('user-name-input').value;
            const mobile = document.getElementById('user-mobile-input').value;
            const upiId = document.getElementById('user-upi-input').value;
            const address = document.getElementById('user-address-input').value;
            const password = document.getElementById('user-password-input').value;
            
            const updates = { name, mobile, upiId, address };
            if (password) {
                updates.password = password;
            }
            
            try {
                await usersRef.child(currentUser.uid).update(updates);
                showModal('Profile updated successfully!');
                currentUser = { ...currentUser, ...updates };
            } catch (error) {
                showModal('Failed to update profile: ' + error.message);
            }
        });
        
        async function requestWithdrawal() {
            const amount = parseFloat(document.getElementById('withdraw-amount').value);
            if (isNaN(amount) || amount < 50) {
                showModal('Minimum withdrawal amount is ₹50.');
                return;
            }

            if (amount > currentUser.balance) {
                showModal('Insufficient balance.');
                return;
            }

            showConfirmModal(`Are you sure you want to withdraw ₹${amount}?`, async () => {
                const newWithdrawal = {
                    userId: currentUser.uid,
                    userName: currentUser.name,
                    amount: amount,
                    status: 'pending',
                    timestamp: new Date().toISOString()
                };

                try {
                    await withdrawalsRef.push(newWithdrawal);
                    await usersRef.child(currentUser.uid).update({ balance: currentUser.balance - amount });
                    showModal('Withdrawal request submitted successfully! It will be processed soon.');
                    document.getElementById('withdraw-amount').value = '';
                } catch (error) {
                    showModal('Failed to submit withdrawal request: ' + error.message);
                }
            });
        }
        
        function showDownline() {
            showView('downline-view');
            loadDownline();
        }

        function loadDownline() {
            const downlineList = document.getElementById('downline-list');
            downlineList.innerHTML = '';
            
            if (!currentUser || currentUser.status !== 'active') {
                downlineList.innerHTML = '<p class="text-gray-600">Your account must be active to view your team.</p>';
                return;
            }

            usersRef.orderByChild('upline').equalTo(currentUser.uid).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    let downlineCount = 0;
                    snapshot.forEach((childSnapshot) => {
                        const user = childSnapshot.val();
                        downlineCount++;
                        const downlineItem = document.createElement('div');
                        downlineItem.className = 'flex justify-between items-center p-4 border-b last:border-b-0';
                        downlineItem.innerHTML = `
                            <span>${user.name}</span>
                            <span class="text-xs text-gray-500">${user.status}</span>
                        `;
                        downlineList.appendChild(downlineItem);
                    });
                    downlineList.prepend(document.createElement('p').innerHTML = `<p class="font-bold text-lg mb-4">Total Team Members: ${downlineCount}</p>`);
                } else {
                    downlineList.innerHTML = '<p class="text-gray-600">You have no team members yet.</p>';
                }
            });
        }
        
        function showAppsGames() {
            showView('apps-games-view');
            loadAppLinks();
        }
        
        function loadAppLinks() {
            const appLinksContainer = document.getElementById('app-game-links');
            appLinksContainer.innerHTML = '';
            appLinksRef.once('value', (snapshot) => {
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const link = childSnapshot.val();
                        const linkItem = document.createElement('div');
                        linkItem.className = 'bg-white p-4 rounded-xl shadow-lg flex justify-between items-center';
                        linkItem.innerHTML = `
                            <p class="font-bold">${link.name}</p>
                            <a href="${link.url}" target="_blank" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Open</a>
                        `;
                        appLinksContainer.appendChild(linkItem);
                    });
                } else {
                    appLinksContainer.innerHTML = '<p class="text-gray-600">No apps or games available yet.</p>';
                }
            });
        }
        
        function showVideos() {
            showView('videos-view');
            loadVideoLinks();
        }
        
        function loadVideoLinks() {
            const videoLinksContainer = document.getElementById('video-links');
            videoLinksContainer.innerHTML = '';
            videoLinksRef.once('value', (snapshot) => {
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const video = childSnapshot.val();
                        const videoItem = document.createElement('div');
                        videoItem.className = 'bg-white p-4 rounded-xl shadow-lg';
                        videoItem.innerHTML = `
                            <h4 class="font-bold mb-2">${video.name}</h4>
                            <div class="relative" style="padding-bottom: 56.25%;">
                                <iframe class="absolute top-0 left-0 w-full h-full rounded-md" src="${video.url.replace("watch?v=", "embed/")}" frameborder="0" allowfullscreen></iframe>
                            </div>
                        `;
                        videoLinksContainer.appendChild(videoItem);
                    });
                } else {
                    videoLinksContainer.innerHTML = '<p class="text-gray-600">No videos available yet.</p>';
                }
            });
        }
        
        function showSupport() {
            showView('support-view');
            loadChatMessages();
        }
        
        function sendMessageToAdmin() {
            const chatInput = document.getElementById('chat-input');
            const message = chatInput.value.trim();
            if (message === '' || !currentUser) return;
            
            const messageData = {
                senderId: currentUser.uid,
                senderName: currentUser.name,
                receiverId: 'admin_uid',
                message: message,
                timestamp: new Date().toISOString(),
                isUserMessage: true
            };
            
            messagesRef.push(messageData);
            chatInput.value = '';
        }
        
        function loadChatMessages() {
            const chatMessagesContainer = document.getElementById('chat-messages');
            chatMessagesContainer.innerHTML = '';
            messagesRef.orderByChild('timestamp').on('value', (snapshot) => {
                chatMessagesContainer.innerHTML = '';
                snapshot.forEach((childSnapshot) => {
                    const message = childSnapshot.val();
                    if (message.senderId === currentUser.uid || message.receiverId === currentUser.uid) {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = `p-3 rounded-lg max-w-xs ${message.isUserMessage ? 'bg-blue-100 self-end' : 'bg-gray-200 self-start'}`;
                        messageDiv.innerText = message.message;
                        chatMessagesContainer.appendChild(messageDiv);
                    }
                });
                chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
            });
        }

        function copyReferralCode() {
            const code = document.getElementById('my-referral-code').innerText;
            navigator.clipboard.writeText(code).then(() => {
                showModal('Referral code copied to clipboard!');
            }).catch(err => {
                showModal('Could not copy code. Please copy manually.');
            });
        }

        function shareApp() {
            if (navigator.share) {
                navigator.share({
                    title: 'EarnHub App',
                    text: `Join EarnHub and start earning! Use my referral code: ${currentUser.referralCode}`,
                    url: appShareUrl,
                }).then(() => console.log('Successful share'))
                  .catch((error) => console.log('Error sharing:', error));
            } else {
                const shareMessage = `Join EarnHub and start earning! Use my referral code: ${currentUser.referralCode}\n${appShareUrl}`;
                navigator.clipboard.writeText(shareMessage).then(() => {
                    showModal('Referral link copied to clipboard!');
                }).catch(err => {
                    showModal('Could not copy link to clipboard. Please copy manually.');
                });
            }
        }
        
        // --- Product Listing Functions ---
        async function handleProductSubmit(event) {
            event.preventDefault();
            const productId = document.getElementById('product-id').value;
            const title = document.getElementById('product-title').value;
            const description = document.getElementById('product-description').value;
            const mrp = parseFloat(document.getElementById('product-mrp').value);
            const price = parseFloat(document.getElementById('product-price').value);
            const offer = parseFloat(document.getElementById('product-offer').value);
            const rating = parseFloat(document.getElementById('product-rating').value);
            const image1 = document.getElementById('product-image1').value;
            const image2 = document.getElementById('product-image2').value;
            const image3 = document.getElementById('product-image3').value;
            const video = document.getElementById('product-video').value;

            if (!title || !price || !image1) {
                showModal('Title, Price, and at least one Image URL are required.');
                return;
            }

            const productData = {
                title,
                description,
                mrp: mrp > 0 ? mrp : null,
                price,
                offer: offer > 0 ? offer : null,
                rating: rating > 0 ? rating : null,
                images: [image1, image2, image3].filter(url => url),
                video,
            };

            try {
                if (productId) {
                    await productsRef.child(productId).update(productData);
                    showModal('Product updated successfully!');
                } else {
                    await productsRef.push({ ...productData, createdAt: new Date().toISOString() });
                    showModal('Product listed successfully!');
                }
                document.getElementById('product-form').reset();
                document.getElementById('product-id').value = '';
                loadProductsAdmin();
                loadProductsUser();
                loadProductsDashboard();
            } catch (error) {
                showModal('Failed to save product: ' + error.message);
            }
        }
        
        function loadProductsAdmin() {
            const productListAdmin = document.getElementById('product-list-admin');
            productListAdmin.innerHTML = '';
            productsRef.on('value', (snapshot) => {
                productListAdmin.innerHTML = '';
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const product = childSnapshot.val();
                        const productId = childSnapshot.key;
                        const productCard = document.createElement('div');
                        productCard.className = 'p-4 border rounded-lg mb-4 bg-gray-50';
                        productCard.innerHTML = `
                            <h4 class="font-bold">${product.title}</h4>
                            <p><strong>Price:</strong> ₹${product.price}</p>
                            <p><strong>MRP:</strong> ₹${product.mrp || 'N/A'}</p>
                            <button onclick="editProduct('${productId}')" class="bg-blue-500 text-white px-3 py-1 rounded-md mt-2 hover:bg-blue-600">Edit</button>
                            <button onclick="deleteProduct('${productId}')" class="bg-red-500 text-white px-3 py-1 rounded-md mt-2 hover:bg-red-600">Delete</button>
                        `;
                        productListAdmin.appendChild(productCard);
                    });
                } else {
                    productListAdmin.innerHTML = '<p class="text-gray-600">No products listed yet.</p>';
                }
            });
        }
        
        async function editProduct(productId) {
            const productSnapshot = await productsRef.child(productId).once('value');
            const product = productSnapshot.val();
            if (product) {
                document.getElementById('product-id').value = productId;
                document.getElementById('product-title').value = product.title;
                document.getElementById('product-description').value = product.description;
                document.getElementById('product-mrp').value = product.mrp;
                document.getElementById('product-price').value = product.price;
                document.getElementById('product-offer').value = product.offer;
                document.getElementById('product-rating').value = product.rating;
                document.getElementById('product-image1').value = product.images[0] || '';
                document.getElementById('product-image2').value = product.images[1] || '';
                document.getElementById('product-image3').value = product.images[2] || '';
                document.getElementById('product-video').value = product.video || '';
            }
        }

        function deleteProduct(productId) {
            showConfirmModal('Are you sure you want to delete this product?', async () => {
                try {
                    await productsRef.child(productId).remove();
                    showModal('Product deleted successfully!');
                    loadProductsAdmin();
                    loadProductsUser();
                } catch (error) {
                    showModal('Failed to delete product: ' + error.message);
                }
            });
        }
        
        function showProducts() {
            showView('products-view');
            loadProductsUser();
        }

        function loadProductsUser() {
            const productList = document.getElementById('product-list');
            productList.innerHTML = '';
            productsRef.on('value', (snapshot) => {
                productList.innerHTML = '';
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const product = childSnapshot.val();
                        const productId = childSnapshot.key;
                        const productCard = document.createElement('div');
                        productCard.className = 'bg-white p-6 rounded-xl shadow-lg flex flex-col items-center text-center';
                        
                        const priceHtml = product.mrp > 0 ? 
                            `<p class="text-gray-500 line-through">MRP: ₹${product.mrp}</p>
                             <p class="text-2xl font-bold text-blue-600">₹${product.price}</p>` : 
                            `<p class="text-2xl font-bold text-blue-600">₹${product.price}</p>`;

                        productCard.innerHTML = `
                            <img src="${product.images[0]}" alt="${product.title}" class="w-full h-48 object-cover rounded-md mb-4">
                            <h3 class="text-xl font-bold mb-2">${product.title}</h3>
                            ${priceHtml}
                            <p class="text-yellow-500 mt-2">${'★'.repeat(Math.floor(product.rating))}${'☆'.repeat(5 - Math.floor(product.rating))}</p>
                            <button onclick="showProductDetail('${productId}')" class="mt-4 w-full bg-blue-600 text-white font-bold py-2 rounded-md hover:bg-blue-700">View Details</button>
                        `;
                        productList.appendChild(productCard);
                    });
                } else {
                    productList.innerHTML = '<p class="text-gray-600">No products listed yet.</p>';
                }
            });
        }

        function loadProductsDashboard() {
            const productListDashboard = document.getElementById('product-list-dashboard');
            productListDashboard.innerHTML = '';
            productsRef.on('value', (snapshot) => {
                productListDashboard.innerHTML = '';
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const product = childSnapshot.val();
                        const productId = childSnapshot.key;
                        const productCard = document.createElement('div');
                        productCard.className = 'bg-white p-6 rounded-xl shadow-lg flex flex-col items-center text-center';
                        
                        const priceHtml = product.mrp > 0 ? 
                            `<p class="text-gray-500 line-through">MRP: ₹${product.mrp}</p>
                             <p class="text-2xl font-bold text-blue-600">₹${product.price}</p>` : 
                            `<p class="text-2xl font-bold text-blue-600">₹${product.price}</p>`;

                        productCard.innerHTML = `
                            <img src="${product.images[0]}" alt="${product.title}" class="w-full h-48 object-cover rounded-md mb-4">
                            <h3 class="text-xl font-bold mb-2">${product.title}</h3>
                            ${priceHtml}
                            <p class="text-yellow-500 mt-2">${'★'.repeat(Math.floor(product.rating))}${'☆'.repeat(5 - Math.floor(product.rating))}</p>
                            <button onclick="showProductDetail('${productId}')" class="mt-4 w-full bg-blue-600 text-white font-bold py-2 rounded-md hover:bg-blue-700">View Details</button>
                        `;
                        productListDashboard.appendChild(productCard);
                    });
                } else {
                    productListDashboard.innerHTML = '<p class="text-gray-600">No products listed yet.</p>';
                }
            });
        }

        async function showProductDetail(productId) {
            const productSnapshot = await productsRef.child(productId).once('value');
            const product = productSnapshot.val();
            if (!product) {
                showModal('Product not found.');
                return;
            }

            let imageGalleryHtml = product.images.map(imgUrl => `<img src="${imgUrl}" alt="${product.title}" />`).join('');
            let youtubeVideoHtml = product.video ? `
                <div class="mt-6">
                    <h4 class="font-bold text-lg mb-2">Product Video</h4>
                    <div class="relative" style="padding-bottom: 56.25%;">
                        <iframe class="absolute top-0 left-0 w-full h-full rounded-md" src="${product.video.replace("watch?v=", "embed/")}" frameborder="0" allowfullscreen></iframe>
                    </div>
                </div>
            ` : '';
            
            const content = `
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-2xl font-bold">${product.title}</h3>
                    <button onclick="hideProductDetailModal()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times text-xl"></i></button>
                </div>
                <div class="image-gallery mb-4">
                    ${imageGalleryHtml}
                </div>
                <p class="text-xl font-bold text-blue-600">₹${product.price} <span class="text-gray-500 text-sm line-through">MRP: ₹${product.mrp || 'N/A'}</span></p>
                <p class="text-gray-600 mt-2">${product.description}</p>
                ${youtubeVideoHtml}
                <div class="flex justify-between mt-6">
                    <button onclick="handleBuyProductClick('${productId}')" class="bg-green-600 text-white px-6 py-2 rounded-md font-bold hover:bg-green-700">Buy Now</button>
                    <p class="text-xl font-bold text-green-600">Income Offer: ₹${product.offer || 0}</p>
                </div>
            `;
            showProductDetailModal(content);
        }

        async function handleBuyProductClick(productId) {
            hideProductDetailModal();
            if (!currentUser) {
                showModal('Please log in to buy products.');
                return;
            }
            if (currentUser.status === 'pending') {
                showModal('Your account must be active to buy products.');
                return;
            }
            
            const productSnapshot = await productsRef.child(productId).once('value');
            const product = productSnapshot.val();
            if (product) {
                showBuyProductModal({ id: productId, title: product.title, price: product.price });
            } else {
                showModal('Product not found.');
            }
        }
        
        async function submitProductRequest() {
            if (!currentUser) {
                hideBuyProductModal();
                showModal('Please log in to submit a request.');
                return;
            }
            if (currentUser.status === 'pending') {
                hideBuyProductModal();
                showModal('Your account must be active to buy products.');
                return;
            }
            
            const amount = parseFloat(buyProductAmountInput.value);
            if (isNaN(amount) || amount <= 0) {
                showModal('Please enter a valid amount.');
                return;
            }

            const productId = pendingBuyRequest.productId;
            const productTitle = pendingBuyRequest.productTitle;
            
            const newOrder = {
                userId: currentUser.uid,
                userName: currentUser.name,
                userStatus: currentUser.status,
                productId: productId,
                productTitle: productTitle,
                amountPaid: amount,
                incomeOffer: 0,
                status: 'pending',
                timestamp: new Date().toISOString()
            };

            try {
                const newOrderRef = ordersRef.push(newOrder);
                await newOrderRef;
                console.log("Order request successfully submitted:", newOrderRef.key);
                hideBuyProductModal();
                showModal('Order request submitted successfully! We will contact you soon.');
            } catch (error) {
                console.error("Failed to submit order request:", error);
                showModal('Failed to submit order request: ' + error.message);
            }
        }
        
        // --- Admin Panel Logic ---
        function loadAdminData() {
            loadUsersAdmin();
            loadWithdrawalRequests();
            loadOrderRequests();
            loadPublicMessage();
            loadAppLinksAdmin();
            loadVideoLinksAdmin();
            loadProductsAdmin();
            loadAdminChatList();
        }

        function loadUsersAdmin() {
            const userList = document.getElementById('user-list');
            userList.innerHTML = '';
            usersRef.on('value', (snapshot) => {
                userList.innerHTML = '';
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const user = childSnapshot.val();
                        const userId = childSnapshot.key;
                        if (userId === currentUser.uid) return;
                        
                        const userDiv = document.createElement('div');
                        userDiv.className = `p-4 border rounded-lg mb-2 ${user.status === 'pending' ? 'bg-yellow-100' : 'bg-gray-50'}`;
                        userDiv.innerHTML = `
                            <p><strong>Name:</strong> ${user.name}</p>
                            <p><strong>Username:</strong> ${user.username}</p>
                            <p><strong>Status:</strong> <span class="font-bold">${user.status}</span></p>
                            <div class="mt-2 flex space-x-2">
                                <button onclick="showAdminProfile('${userId}')" class="bg-blue-500 text-white px-3 py-1 rounded-md hover:bg-blue-600">View Profile</button>
                                ${user.status === 'pending' ? `<button onclick="approveUser('${userId}')" class="bg-green-500 text-white px-3 py-1 rounded-md hover:bg-green-600">Approve</button>` : ''}
                                ${user.status === 'active' ? `<button onclick="blockUser('${userId}')" class="bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600">Block</button>` : ''}
                                <button onclick="deleteUser('${userId}')" class="bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600">Delete</button>
                                <button onclick="startAdminChat('${userId}', '${user.name}')" class="bg-gray-500 text-white px-3 py-1 rounded-md hover:bg-gray-600">Chat</button>
                            </div>
                        `;
                        userList.appendChild(userDiv);
                    });
                }
            });
        }
        
        async function showAdminProfile(userId) {
            const userSnapshot = await usersRef.child(userId).once('value');
            const user = userSnapshot.val();
            if (!user) return;

            const content = `
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-2xl font-bold">User Profile: ${user.name}</h3>
                    <button onclick="hideAdminProfileModal()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times text-xl"></i></button>
                </div>
                <p><strong>Username:</strong> ${user.username}</p>
                <p><strong>Mobile:</strong> ${user.mobile || 'N/A'}</p>
                <p><strong>UPI ID:</strong> ${user.upiId || 'N/A'}</p>
                <p><strong>Address:</strong> ${user.address || 'N/A'}</p>
                <p><strong>Referral Code:</strong> ${user.referralCode}</p>
                <p><strong>Upline:</strong> ${user.upline || 'N/A'}</p>
                <p><strong>Status:</strong> <span class="font-bold">${user.status}</span></p>
                <div class="mt-6 bg-gray-100 p-4 rounded-lg">
                    <h4 class="text-xl font-bold mb-2">Income Details</h4>
                    <p><strong>Total Income:</strong> ₹${user.balance || 0}</p>
                    <p><strong>Referral Income:</strong> ₹${user.referralIncome || 0}</p>
                    <p><strong>Self Income:</strong> ₹${user.selfIncome || 0}</p>
                    <p><strong>Team Repurchase Income:</strong> ₹${user.teamRepurchaseIncome || 0}</p>
                </div>
            `;
            showAdminProfileModal(content);
        }
        
        async function approveUser(userId) {
            showConfirmModal('Are you sure you want to approve this user?', async () => {
                try {
                    await usersRef.child(userId).update({ status: 'active' });
                    showModal('User approved successfully!');
                } catch (error) {
                    showModal('Failed to approve user: ' + error.message);
                }
            });
        }
        
        async function blockUser(userId) {
            showConfirmModal('Are you sure you want to block this user?', async () => {
                try {
                    await usersRef.child(userId).update({ status: 'blocked' });
                    showModal('User blocked successfully!');
                } catch (error) {
                    showModal('Failed to block user: ' + error.message);
                }
            });
        }

        async function deleteUser(userId) {
            showConfirmModal('Are you sure you want to permanently delete this user and all their data?', async () => {
                try {
                    await usersRef.child(userId).remove();
                    showModal('User deleted successfully!');
                } catch (error) {
                    showModal('Failed to delete user: ' + error.message);
                }
            });
        }
        
        function loadWithdrawalRequests() {
            const requestsList = document.getElementById('withdrawal-requests');
            requestsList.innerHTML = '';
            withdrawalsRef.on('value', (snapshot) => {
                requestsList.innerHTML = '';
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const request = childSnapshot.val();
                        const requestId = childSnapshot.key;
                        const requestDiv = document.createElement('div');
                        requestDiv.className = 'p-4 border rounded-lg mb-2 bg-gray-50';
                        requestDiv.innerHTML = `
                            <p><strong>User:</strong> ${request.userName}</p>
                            <p><strong>Amount:</strong> ₹${request.amount}</p>
                            <p><strong>Status:</strong> <span class="font-bold">${request.status}</span></p>
                            <div class="mt-2 flex space-x-2">
                                ${request.status === 'pending' ? `<button onclick="approveWithdrawal('${requestId}')" class="bg-green-500 text-white px-3 py-1 rounded-md hover:bg-green-600">Approve</button>` : ''}
                                ${request.status === 'pending' ? `<button onclick="rejectWithdrawal('${requestId}')" class="bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600">Reject</button>` : ''}
                                <button onclick="deleteWithdrawal('${requestId}')" class="bg-gray-500 text-white px-3 py-1 rounded-md hover:bg-gray-600">Delete</button>
                            </div>
                        `;
                        requestsList.appendChild(requestDiv);
                    });
                } else {
                    requestsList.innerHTML = '<p class="text-gray-600">No withdrawal requests.</p>';
                }
            });
        }

        async function deleteWithdrawal(requestId) {
            showConfirmModal('Delete this withdrawal record?', async () => {
                try {
                    await withdrawalsRef.child(requestId).remove();
                    showModal('Withdrawal record deleted!');
                } catch (error) {
                    showModal('Failed to delete record: ' + error.message);
                }
            });
        }
        
        async function approveWithdrawal(requestId) {
            showConfirmModal('Approve this withdrawal?', async () => {
                try {
                    await withdrawalsRef.child(requestId).update({ status: 'approved' });
                    showModal('Withdrawal approved.');
                } catch (error) {
                    showModal('Failed to approve withdrawal: ' + error.message);
                }
            });
        }
        
        async function rejectWithdrawal(requestId) {
            showConfirmModal('Reject this withdrawal?', async () => {
                try {
                    await withdrawalsRef.child(requestId).update({ status: 'rejected' });
                    showModal('Withdrawal rejected.');
                } catch (error) {
                    showModal('Failed to reject withdrawal: ' + error.message);
                }
            });
        }

        function loadOrderRequests() {
            const requestsList = document.getElementById('order-requests');
            requestsList.innerHTML = '';
            ordersRef.on('value', (snapshot) => {
                requestsList.innerHTML = '';
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const request = childSnapshot.val();
                        const orderId = childSnapshot.key;
                        if (request.status !== 'pending') return;

                        const requestDiv = document.createElement('div');
                        requestDiv.className = 'p-4 border rounded-lg mb-2 bg-gray-50';
                        requestDiv.innerHTML = `
                            <p><strong>User:</strong> ${request.userName}</p>
                            <p><strong>User Status:</strong> ${request.userStatus}</p>
                            <p><strong>Product:</strong> ${request.productTitle}</p>
                            <p><strong>Amount Paid:</strong> ₹${request.amountPaid}</p>
                            <p><strong>Status:</strong> <span class="font-bold">${request.status}</span></p>
                            <div class="mt-2">
                                <label class="block mb-1">Repurchase Income (₹)</label>
                                <input type="number" id="income-${orderId}" placeholder="Enter amount" class="w-full px-3 py-1 rounded-md border border-gray-300">
                            </div>
                            <div class="mt-2 flex space-x-2">
                                <button onclick="approveOrderWithIncome('${orderId}')" class="bg-green-500 text-white px-3 py-1 rounded-md hover:bg-green-600">Approve & Distribute</button>
                                <button onclick="cancelOrder('${orderId}')" class="bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600">Cancel</button>
                                <button onclick="deleteOrder('${orderId}')" class="bg-gray-500 text-white px-3 py-1 rounded-md hover:bg-gray-600">Delete</button>
                            </div>
                        `;
                        requestsList.appendChild(requestDiv);
                    });
                } else {
                    requestsList.innerHTML = '<p class="text-gray-600">No new orders.</p>';
                }
            });
        }

        async function deleteOrder(orderId) {
            showConfirmModal('Delete this order record?', async () => {
                try {
                    await ordersRef.child(orderId).remove();
                    showModal('Order record deleted!');
                } catch (error) {
                    showModal('Failed to delete record: ' + error.message);
                }
            });
        }
        
        async function approveOrderWithIncome(orderId) {
            const incomeInput = document.getElementById(`income-${orderId}`);
            const incomeOffer = parseFloat(incomeInput.value);

            if (isNaN(incomeOffer) || incomeOffer <= 0) {
                showModal('Please enter a valid repurchase income amount.');
                return;
            }

            const orderSnapshot = await ordersRef.child(orderId).once('value');
            const order = orderSnapshot.val();

            if (!order) {
                showModal('Order not found.');
                return;
            }
            
            showConfirmModal(`Approve this order and distribute ₹${incomeOffer} income?`, async () => {
                try {
                    const userSnapshot = await usersRef.child(order.userId).once('value');
                    const user = userSnapshot.val();
                    if (!user) {
                        showModal('User not found.');
                        return;
                    }

                    const selfPercent = 30;
                    const firstUplinePercent = 30;
                    const secondUplinePercent = 20;
                    const thirdUplinePercent = 20;

                    const selfIncome = (incomeOffer * selfPercent) / 100;
                    const firstUplineIncome = (incomeOffer * firstUplinePercent) / 100;
                    const secondUplineIncome = (incomeOffer * secondUplinePercent) / 100;
                    const thirdUplineIncome = (incomeOffer * thirdUplinePercent) / 100;

                    await usersRef.child(order.userId).transaction((userData) => {
                        if (userData) {
                            userData.balance = (userData.balance || 0) + selfIncome;
                            userData.selfIncome = (userData.selfIncome || 0) + selfIncome;
                        }
                        return userData;
                    });
                    
                    let currentUplineId = user.upline;
                    let level = 1;
                    
                    while (currentUplineId && level <= 3) {
                        const uplineSnapshot = await usersRef.child(currentUplineId).once('value');
                        const uplineUser = uplineSnapshot.val();
                        
                        if (uplineUser) {
                            let incomeToDistribute = 0;
                            if (level === 1) incomeToDistribute = firstUplineIncome;
                            if (level === 2) incomeToDistribute = secondUplineIncome;
                            if (level === 3) incomeToDistribute = thirdUplineIncome;

                            await usersRef.child(currentUplineId).transaction((uplineData) => {
                                if (uplineData) {
                                    uplineData.balance = (uplineData.balance || 0) + incomeToDistribute;
                                    uplineData.referralIncome = (uplineData.referralIncome || 0) + incomeToDistribute;
                                    uplineData.teamRepurchaseIncome = (uplineData.teamRepurchaseIncome || 0) + incomeToDistribute;
                                }
                                return uplineData;
                            });

                            currentUplineId = uplineUser.upline;
                            level++;
                        } else {
                            break;
                        }
                    }

                    await ordersRef.child(orderId).update({ status: 'approved', incomeOffer: incomeOffer });
                    showModal('Order approved and income distributed successfully!');
                } catch (error) {
                    showModal('Failed to approve order and distribute income: ' + error.message);
                }
            });
        }
        
        async function cancelOrder(orderId) {
            showConfirmModal('Cancel this order?', async () => {
                try {
                    await ordersRef.child(orderId).update({ status: 'cancelled' });
                    showModal('Order cancelled.');
                } catch (error) {
                    showModal('Failed to cancel order: ' + error.message);
                }
            });
        }
        
        async function postPublicMessage() {
            const message = document.getElementById('public-message').value.trim();
            if (message) {
                try {
                    await publicMessageRef.set(message);
                    showModal('Public message posted successfully!');
                    document.getElementById('public-message').value = '';
                } catch (error) {
                    showModal('Failed to post message: ' + error.message);
                }
            }
        }
        
        function loadPublicMessage() {
            const publicMessageText = document.getElementById('public-message-text');
            publicMessageRef.on('value', (snapshot) => {
                const message = snapshot.val();
                if (message) {
                    publicMessageText.innerText = message;
                } else {
                    publicMessageText.innerText = 'Welcome to EarnHub!';
                }
            });
        }

        function loadAppLinksAdmin() {
            const appLinksContainer = document.getElementById('app-links-admin');
            appLinksContainer.innerHTML = '';
            appLinksRef.on('value', (snapshot) => {
                appLinksContainer.innerHTML = '';
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const link = childSnapshot.val();
                        const linkId = childSnapshot.key;
                        const linkItem = document.createElement('div');
                        linkItem.className = 'bg-gray-50 p-3 rounded-lg mb-2 flex justify-between items-center';
                        linkItem.innerHTML = `
                            <span>${link.name}</span>
                            <div>
                                <button onclick="editAppLink('${linkId}')" class="bg-blue-500 text-white px-2 py-1 text-sm rounded-md hover:bg-blue-600">Edit</button>
                                <button onclick="deleteAppLink('${linkId}')" class="bg-red-500 text-white px-2 py-1 text-sm rounded-md hover:bg-red-600">Delete</button>
                            </div>
                        `;
                        appLinksContainer.appendChild(linkItem);
                    });
                }
            });
        }

        document.getElementById('app-link-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const linkId = document.getElementById('app-link-id').value;
            const name = document.getElementById('app-link-name').value;
            const url = document.getElementById('app-link-url').value;

            if (!name || !url) {
                showModal('Please fill in both name and URL.');
                return;
            }

            try {
                if (linkId) {
                    await appLinksRef.child(linkId).update({ name, url });
                    showModal('Link updated successfully!');
                } else {
                    await appLinksRef.push({ name, url });
                    showModal('Link added successfully!');
                }
                document.getElementById('app-link-form').reset();
                document.getElementById('app-link-id').value = '';
                loadAppLinksAdmin();
                loadAppLinks();
            } catch (error) {
                showModal('Failed to manage link: ' + error.message);
            }
        });
        
        async function editAppLink(linkId) {
            const linkSnapshot = await appLinksRef.child(linkId).once('value');
            const link = linkSnapshot.val();
            if (link) {
                document.getElementById('app-link-id').value = linkId;
                document.getElementById('app-link-name').value = link.name;
                document.getElementById('app-link-url').value = link.url;
            }
        }

        function deleteAppLink(linkId) {
            showConfirmModal('Delete this link?', async () => {
                try {
                    await appLinksRef.child(linkId).remove();
                    showModal('Link deleted!');
                    loadAppLinksAdmin();
                    loadAppLinks();
                } catch (error) {
                    showModal('Failed to delete link: ' + error.message);
                }
            });
        }
        
        function loadVideoLinksAdmin() {
            const videoLinksContainer = document.getElementById('video-list-admin');
            videoLinksContainer.innerHTML = '';
            videoLinksRef.on('value', (snapshot) => {
                videoLinksContainer.innerHTML = '';
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const video = childSnapshot.val();
                        const videoId = childSnapshot.key;
                        const videoItem = document.createElement('div');
                        videoItem.className = 'bg-gray-50 p-3 rounded-lg mb-2 flex justify-between items-center';
                        videoItem.innerHTML = `
                            <span>${video.name}</span>
                            <div>
                                <button onclick="editVideoLink('${videoId}')" class="bg-blue-500 text-white px-2 py-1 text-sm rounded-md hover:bg-blue-600">Edit</button>
                                <button onclick="deleteVideoLink('${videoId}')" class="bg-red-500 text-white px-2 py-1 text-sm rounded-md hover:bg-red-600">Delete</button>
                            </div>
                        `;
                        videoLinksContainer.appendChild(videoItem);
                    });
                }
            });
        }

        document.getElementById('video-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const videoId = document.getElementById('video-id').value;
            const name = document.getElementById('video-name').value;
            const url = document.getElementById('video-url').value;

            if (!name || !url) {
                showModal('Please fill in both name and URL.');
                return;
            }

            try {
                if (videoId) {
                    await videoLinksRef.child(videoId).update({ name, url });
                    showModal('Video link updated successfully!');
                } else {
                    await videoLinksRef.push({ name, url });
                    showModal('Video link added successfully!');
                }
                document.getElementById('video-form').reset();
                document.getElementById('video-id').value = '';
                loadVideoLinksAdmin();
                loadVideoLinks();
            } catch (error) {
                showModal('Failed to manage video link: ' + error.message);
            }
        });
        
        async function editVideoLink(videoId) {
            const videoSnapshot = await videoLinksRef.child(videoId).once('value');
            const video = videoSnapshot.val();
            if (video) {
                document.getElementById('video-id').value = videoId;
                document.getElementById('video-name').value = video.name;
                document.getElementById('video-url').value = video.url;
            }
        }
        
        function deleteVideoLink(videoId) {
            showConfirmModal('Delete this video link?', async () => {
                try {
                    await videoLinksRef.child(videoId).remove();
                    showModal('Video link deleted!');
                    loadVideoLinksAdmin();
                    loadVideoLinks();
                } catch (error) {
                    showModal('Failed to delete video link: ' + error.message);
                }
            });
        }
        
        function loadAdminChatList() {
            const adminChatList = document.getElementById('admin-chat-list');
            adminChatList.innerHTML = '';
            messagesRef.on('value', (snapshot) => {
                adminChatList.innerHTML = '';
                const usersWithMessages = {};
                snapshot.forEach((childSnapshot) => {
                    const message = childSnapshot.val();
                    if (message.receiverId === 'admin_uid' && !usersWithMessages[message.senderId]) {
                        usersWithMessages[message.senderId] = message.senderName;
                    }
                });

                for (const userId in usersWithMessages) {
                    const userName = usersWithMessages[userId];
                    const chatItem = document.createElement('div');
                    chatItem.className = 'bg-gray-50 p-3 rounded-lg mb-2 flex justify-between items-center';
                    chatItem.innerHTML = `
                        <span><strong>${userName}</strong></span>
                        <div>
                            <button onclick="startAdminChat('${userId}', '${userName}')" class="bg-blue-500 text-white px-2 py-1 text-sm rounded-md hover:bg-blue-600">Open Chat</button>
                            <button onclick="deleteChat('${userId}')" class="bg-red-500 text-white px-2 py-1 text-sm rounded-md hover:bg-red-600">Delete Chat</button>
                        </div>
                    `;
                    adminChatList.appendChild(chatItem);
                }
            });
        }

        function deleteChat(userId) {
            showConfirmModal('Are you sure you want to delete this chat history?', async () => {
                try {
                    const messagesToDelete = await messagesRef.orderByChild('senderId').equalTo(userId).once('value');
                    messagesToDelete.forEach(messageSnapshot => {
                        messageSnapshot.ref.remove();
                    });
                    const messagesToDelete2 = await messagesRef.orderByChild('receiverId').equalTo(userId).once('value');
                    messagesToDelete2.forEach(messageSnapshot => {
                        messageSnapshot.ref.remove();
                    });
                    showModal('Chat history deleted successfully!');
                } catch (error) {
                    showModal('Failed to delete chat: ' + error.message);
                }
            });
        }
        
        function startAdminChat(userId, userName) {
            activeAdminChatUserId = userId;
            showAdminChatModal(userName);
            loadAdminChatMessages(userId);
        }
        
        function loadAdminChatMessages(userId) {
            adminChatMessages.innerHTML = '';
            messagesRef.orderByChild('timestamp').on('value', (snapshot) => {
                adminChatMessages.innerHTML = '';
                snapshot.forEach((childSnapshot) => {
                    const message = childSnapshot.val();
                    if ((message.senderId === userId && message.receiverId === 'admin_uid') || (message.senderId === 'admin_uid' && message.receiverId === userId)) {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = `p-3 rounded-lg max-w-xs ${message.isUserMessage ? 'bg-blue-100 self-start' : 'bg-green-100 self-end'}`;
                        messageDiv.innerText = message.message;
                        adminChatMessages.appendChild(messageDiv);
                    }
                });
                adminChatMessages.scrollTop = adminChatMessages.scrollHeight;
            });
        }

        function sendAdminReply() {
            const message = adminChatInput.value.trim();
            if (message === '' || !activeAdminChatUserId) return;

            const messageData = {
                senderId: 'admin_uid',
                senderName: 'Admin',
                receiverId: activeAdminChatUserId,
                message: message,
                timestamp: new Date().toISOString(),
                isUserMessage: false
            };
            messagesRef.push(messageData);
            adminChatInput.value = '';
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            showLoginForm();
            updateTotalMembersCount();
        });
    </script>
</body>
</html>